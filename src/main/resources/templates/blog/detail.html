<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- -->
</head>
<body>
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-2"></div>
        <div class="col-8">
            <div class="card mb-4">
                <div class="card-body">
                    <h2 class="card-title" th:text="${blog.title}"></h2>
                    <p class="card-text mb-2"
                       th:text="${#temporals.format(blog.createdAt, 'yyyy-MM-dd')}"></p>
                    <div class="border p-3 mb-3" th:text="${blog.content}"></div>

                    <a th:href="@{/blogs/{id}/edit(id=${blog.id})}"
                       class="btn btn-sm btn-warning">수정</a>
                    <form th:action="@{/blogs/{id}/delete(id=${blog.id})}"
                          method="post" class="d-inline">
                        <button class="btn btn-sm btn-danger">삭제</button>
                    </form>
                </div>
            </div>
            <!--댓글-->
            <h4 class="mb-3">댓글</h4>
            <div id="comment-list" class="mb-3"></div><!--댓글목록-->
            <div class="card p-3 mb-5"><!--비동기식은 name보다는 id나 class가 중요-->
                <input type="text" id="writer" class="form-control mb-3"
                placeholder="작성자를 입력하세요">
                <textarea id="content" class="form-control mb-2" placeholder="댓글내용"></textarea>
                <button class="btn btn-primary" id="btn-save-comment">댓글등록</button>
            </div>
        </div>
        <div class="col-2"></div>

    </div>
</div>
<!--페이지 출력이 완료된 후 처리할 스크립트-->
<script th:inline="javascript">
    const blogId2 = /*[[${blog.id}]]*/0;
</script>
<script>
    //controller에서 전달된 변수를  thymeleaf가 아닌 스크립트로 받을때
    /*<![CDATA[*/
    const blogId = [[${blog.id}]];
    /*]]>*/

    //댓글 목록 읽어오는 함수
    function loadComment() {
        //문자열과 변수를 문자열로 함깨 사용할때 백틱(`)을 이용
        $.get(`/api/comments/${blogId}`, function (data) {
            let html = '';//초기화
            //읽어온 댓글들을 c에 개별로 전달해서 반복
            //스크립트에서는 thymeleaf명령 사용불가
            //data-변수명 : 태그에 변수를 만들어서 사용
            data.forEach(c => {
                html += `
                   <div class="border rounded p-2 mb-2">
                       <div class="d-flex justify-content-between align-items-center mb-2">
               <strong class="text-primary">${c.writer}</strong>
               <button class="btn btn-sm btn-outline-danger delete-comment" data-id="${c.id}">삭제</button>
           </div>
           <div class="text-dark">${c.content}</div>
                   </div>
                   <button class="btn btn-sm btn-danger delete-comment"
                   data-id="${c.id}">삭제</button>
                `;
            });
            $('#comment-list').html(html);//해당태그에 html을 추가
        });
    }

    //댓글등록, 해당태그를 클릭했을때 ===> .on('click')
    $('#btn-save-comment').click(function () {
        //전달할 값을 만들기
        const commentData = {
            blogId: blogId, //부모번호
            writer: $('#writer').val(), //작성자
            content: $('#content').val() //댓글내용
        };
        $.ajax({
            url: '/api/comments',//요청명
            method: 'POST',//맵핑방식
            contentType: 'application/json', //값의 전달방식
            data: JSON.stringify(commentData),//전달할 데이터
            //Controller에서 작업 처리 후 결과
            success: function () {
                //입력창 내용을 초기화
                $('#writer').val('');
                $('#content').val('');
                loadComment();// 댓글조회처리
            },
            error: function (err) {
                alert('댓글 등록 실패: '+err.responseText);
            }
        });
    });

    //댓글삭제
    $(document).on('click' ,'.delete-comment',function () {
        //this는 이벤트가 발생한 태그에서 data의 이름dl id인 값을 저장(data-id)
        const commentId = $(this).data('id');
        $.ajax({
            url: `/api/comments/${commentId}`,
            method: 'DELETE',
            success: function () {
                loadComment();//댓글을 다시 조회해서 출력

            },
            error: function (err) {
                alert('댓글 삭제 실패; '+err.responseText);
            }
        });
    });
    //function으로 선언된 메소드는 호출을 해서 사용이 가능(그냥 실행불가능)
    //java에서 main()과 같은 시작메소드
    $(document).ready(function () {
        loadComment();//게시글에 해당하는 댓글 출력

    });
</script>
</body>
</html>
<!--//$('#btn-save-comment').click(function ()와
// $(document).on('click' ,'.delete-comment',function ()사용의 차이점
//정적이벤트 : 스크립트를 사용하기 전에 존재하는 태그(id, class)
//$('#btn-save-comment'): 출력후 기억된 id, class에서 찾아서 적용
//동적이벤트 : 스크립트 사용후 생성된 태그(id, class)
//$(document).on('click' :Html을 처음부터 읽어서 id, class를 찾아서 적용-->
